<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ I_Trade_it - Dashboard n8n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            color: #888;
            font-size: 1.1rem;
        }
        
        .config-section {
            max-width: 600px;
            margin: 0 auto 30px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .config-section label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .config-section input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        
        .config-section input:focus {
            outline: none;
            border-color: #00d4ff;
        }
        
        .config-section .hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: -10px;
            margin-bottom: 15px;
        }
        
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .workflow-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        
        .workflow-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0,212,255,0.3);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .workflow-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .workflow-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .workflow-id {
            font-size: 0.75rem;
            color: #666;
            font-family: monospace;
        }
        
        .workflow-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-idle {
            background: rgba(255,255,255,0.1);
            color: #888;
        }
        
        .status-running {
            background: rgba(255,193,7,0.2);
            color: #ffc107;
            animation: pulse 1.5s infinite;
        }
        
        .status-success {
            background: rgba(76,175,80,0.2);
            color: #4caf50;
        }
        
        .status-error {
            background: rgba(244,67,54,0.2);
            color: #f44336;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .workflow-schedule {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 20px;
        }
        
        .workflow-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-execute {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #fff;
        }
        
        .btn-execute:hover {
            background: linear-gradient(135deg, #00e5ff, #00b8d4);
            transform: scale(1.02);
        }
        
        .btn-execute:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-open {
            background: rgba(255,255,255,0.1);
            color: #fff;
            flex: 0.4;
        }
        
        .btn-open:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .execution-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.85rem;
            color: #888;
        }
        
        .execution-info .time {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .execution-info .duration {
            color: #00d4ff;
        }
        
        .run-all-section {
            max-width: 600px;
            margin: 30px auto;
            text-align: center;
        }
        
        .btn-run-all {
            background: linear-gradient(135deg, #7b2cbf, #9c27b0);
            color: #fff;
            padding: 15px 40px;
            font-size: 1.1rem;
        }
        
        .btn-run-all:hover {
            background: linear-gradient(135deg, #9c27b0, #ab47bc);
        }
        
        .history-section {
            max-width: 1200px;
            margin: 40px auto 0;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .history-section h2 {
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(0,0,0,0.2);
        }
        
        .history-item .name {
            font-weight: 500;
        }
        
        .history-item .time {
            color: #888;
            font-size: 0.85rem;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: #fff;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #4caf50, #45a049);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ I_Trade_it Dashboard</h1>
        <p>Contr√¥le et monitoring des workflows n8n</p>
    </div>
    
    <div class="config-section">
        <label for="apiKey">üîë Cl√© API n8n</label>
        <input type="password" id="apiKey" placeholder="Entrez votre cl√© API n8n..." />
        <p class="hint">Cr√©ez une cl√© API dans n8n : Settings ‚Üí API ‚Üí Create API Key</p>
        
        <label for="n8nUrl">üåê URL n8n</label>
        <input type="text" id="n8nUrl" value="https://n8n.srv1230871.hstgr.cloud" />
    </div>
    
    <div class="dashboard" id="dashboard">
        <!-- Les cartes seront g√©n√©r√©es dynamiquement -->
    </div>
    
    <div class="run-all-section">
        <button class="btn btn-run-all" onclick="runAllWorkflows()">
            ‚ö° Ex√©cuter tous les workflows
        </button>
    </div>
    
    <div class="history-section">
        <h2>üìú Historique des ex√©cutions</h2>
        <div class="history-list" id="historyList">
            <p style="color: #666; text-align: center;">Aucune ex√©cution pour le moment</p>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // Configuration des workflows
        const workflows = [
            {
                id: 'VpgJdXUofsw9nNYk',
                name: 'MAJ Positions Actives',
                icon: 'üìä',
                schedule: '18h30 (apr√®s cl√¥ture)',
                description: 'Met √† jour les prix et P&L des positions ouvertes'
            },
            {
                id: 'HG8ZxyeibxJBhpCL',
                name: 'Morning Brief',
                icon: 'üåÖ',
                schedule: '08h00',
                description: 'Brief matinal avec news, m√©t√©o et calendrier'
            },
            {
                id: '8T0qru8eYnuoXU6V',
                name: 'Screening Daily',
                icon: 'üìà',
                schedule: '18h / 18h20 / 22h15',
                description: 'Analyse technique CAC40, SBF120, S&P500'
            },
            {
                id: 'Et9qUyNQA6HYBLBE',
                name: 'WF1 Screening',
                icon: 'üéØ',
                schedule: '07h00',
                description: 'Screening et scoring des valeurs'
            },
            {
                id: '9e1YXzT5Eh7kl2Du',
                name: 'WF2 Analyse Signaux',
                icon: 'ü§ñ',
                schedule: '08h00',
                description: 'Analyse IA des meilleurs candidats'
            }
        ];

        // √âtat des workflows
        const workflowStates = {};
        const executionHistory = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            // Charger la config sauvegard√©e
            const savedApiKey = localStorage.getItem('n8n_api_key');
            const savedUrl = localStorage.getItem('n8n_url');
            
            if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
            if (savedUrl) document.getElementById('n8nUrl').value = savedUrl;
            
            // Sauvegarder la config quand elle change
            document.getElementById('apiKey').addEventListener('change', saveConfig);
            document.getElementById('n8nUrl').addEventListener('change', saveConfig);
            
            // G√©n√©rer les cartes
            renderWorkflows();
        });

        function saveConfig() {
            localStorage.setItem('n8n_api_key', document.getElementById('apiKey').value);
            localStorage.setItem('n8n_url', document.getElementById('n8nUrl').value);
        }

        function renderWorkflows() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = workflows.map(wf => `
                <div class="workflow-card" id="card-${wf.id}">
                    <div class="workflow-header">
                        <div>
                            <div class="workflow-icon">${wf.icon}</div>
                            <div class="workflow-name">${wf.name}</div>
                            <div class="workflow-id">${wf.id}</div>
                        </div>
                        <div class="workflow-status status-idle" id="status-${wf.id}">
                            <span>‚óè</span> Pr√™t
                        </div>
                    </div>
                    <div class="workflow-schedule">
                        <span>‚è∞</span> ${wf.schedule}
                    </div>
                    <div class="workflow-actions">
                        <button class="btn btn-execute" id="btn-${wf.id}" onclick="executeWorkflow('${wf.id}')">
                            ‚ñ∂Ô∏è Ex√©cuter
                        </button>
                        <button class="btn btn-open" onclick="openWorkflow('${wf.id}')">
                            üîó
                        </button>
                    </div>
                    <div class="execution-info" id="info-${wf.id}" style="display: none;">
                        <div class="time">
                            <span>Derni√®re ex√©cution:</span>
                            <span id="lastRun-${wf.id}">-</span>
                        </div>
                        <div class="time">
                            <span>Dur√©e:</span>
                            <span class="duration" id="duration-${wf.id}">-</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function executeWorkflow(workflowId) {
            const apiKey = document.getElementById('apiKey').value;
            const n8nUrl = document.getElementById('n8nUrl').value;
            
            if (!apiKey) {
                showToast('Veuillez entrer votre cl√© API n8n', 'error');
                return;
            }
            
            const workflow = workflows.find(w => w.id === workflowId);
            const btn = document.getElementById(`btn-${workflowId}`);
            const status = document.getElementById(`status-${workflowId}`);
            const info = document.getElementById(`info-${workflowId}`);
            
            // √âtat: En cours
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Ex√©cution...';
            status.className = 'workflow-status status-running';
            status.innerHTML = '<div class="spinner"></div> En cours';
            
            const startTime = Date.now();
            
            try {
                const response = await fetch(`${n8nUrl}/api/v1/workflows/${workflowId}/run`, {
                    method: 'POST',
                    headers: {
                        'X-N8N-API-KEY': apiKey,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                
                if (response.ok) {
                    // Succ√®s
                    status.className = 'workflow-status status-success';
                    status.innerHTML = '<span>‚úì</span> Succ√®s';
                    showToast(`${workflow.icon} ${workflow.name} ex√©cut√© avec succ√®s!`, 'success');
                    
                    addToHistory(workflow, 'success', duration);
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
                
                // Afficher les infos
                info.style.display = 'block';
                document.getElementById(`lastRun-${workflowId}`).textContent = new Date().toLocaleTimeString('fr-FR');
                document.getElementById(`duration-${workflowId}`).textContent = `${duration}s`;
                
            } catch (error) {
                // Erreur
                status.className = 'workflow-status status-error';
                status.innerHTML = '<span>‚úó</span> √âchec';
                showToast(`Erreur: ${error.message}`, 'error');
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                addToHistory(workflow, 'error', duration);
                
                info.style.display = 'block';
                document.getElementById(`lastRun-${workflowId}`).textContent = new Date().toLocaleTimeString('fr-FR');
                document.getElementById(`duration-${workflowId}`).textContent = `${duration}s`;
            }
            
            // R√©activer le bouton
            btn.disabled = false;
            btn.innerHTML = '‚ñ∂Ô∏è Ex√©cuter';
            
            // Reset le statut apr√®s 30 secondes
            setTimeout(() => {
                if (status.classList.contains('status-success') || status.classList.contains('status-error')) {
                    status.className = 'workflow-status status-idle';
                    status.innerHTML = '<span>‚óè</span> Pr√™t';
                }
            }, 30000);
        }

        function openWorkflow(workflowId) {
            const n8nUrl = document.getElementById('n8nUrl').value;
            window.open(`${n8nUrl}/workflow/${workflowId}`, '_blank');
        }

        async function runAllWorkflows() {
            const confirmation = confirm('√ätes-vous s√ªr de vouloir ex√©cuter tous les workflows ?');
            if (!confirmation) return;
            
            for (const wf of workflows) {
                await executeWorkflow(wf.id);
                // Petite pause entre chaque workflow
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        function addToHistory(workflow, status, duration) {
            const historyList = document.getElementById('historyList');
            
            // Supprimer le message "aucune ex√©cution" s'il existe
            if (executionHistory.length === 0) {
                historyList.innerHTML = '';
            }
            
            const entry = {
                workflow,
                status,
                duration,
                time: new Date()
            };
            
            executionHistory.unshift(entry);
            
            // Limiter l'historique √† 20 entr√©es
            if (executionHistory.length > 20) {
                executionHistory.pop();
            }
            
            // Re-render l'historique
            historyList.innerHTML = executionHistory.map(e => `
                <div class="history-item">
                    <div>
                        <span class="name">${e.workflow.icon} ${e.workflow.name}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span class="time">${e.time.toLocaleTimeString('fr-FR')}</span>
                        <span style="color: ${e.status === 'success' ? '#4caf50' : '#f44336'}">
                            ${e.status === 'success' ? '‚úì Succ√®s' : '‚úó √âchec'}
                        </span>
                        <span style="color: #00d4ff">${e.duration}s</span>
                    </div>
                </div>
            `).join('');
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }
    </script>
</body>
</html>
